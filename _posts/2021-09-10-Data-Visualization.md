---
title: 我与数据可视化的那点事儿
tags:
  - programming
  - visual
categories:
  - Blog
author: Hongyang Zhou
---

从事科研若干年，关于成果展示，一句经典老话：“字不如表，表不如图。”从一开始不明所以在海报里塞入大量文字，到后来转而力求简洁清晰的图像，本质上就是随着随着认知的深入能深入浅出地发掘重要信息进行归纳总结。

##

我们频繁接触做图多半是从中学开始学习几何以后。想着当年各种手绘解析几何的直线曲线图形，为后来的电子化做图打下了坚实的基础。这种经典的教学方式如今可能会受到电子化的冲击，但动手画图依旧是我们最快的理解方式。

关于计算机绘图，个人上手最早的经历可以追溯到大一C语言作业要求的命令行输出。当时有一类练习输出的题目就是让你在命令行里画各种图形。现在有一些仿古的绘图库，比如(UnicodePlots)[http://docs.juliaplots.org/latest/generated/unicodeplots]，还能让人依稀回忆起那样的图形风格。真正开始大量实践是从大学物理实验开始的，这系列课程我连上了四个学期，每学期就占1.5个学分，占用的时间和投入的经历却几乎相当于一门3学分的课程。每周一次用一个下午或者一个晚上的时间做实验，然后拿着数据按照要求一通分析，为了写实验报告经常弄得焦头烂额。一开始全电子版的实验报告还不熟练，大部分都是手写的，只是图表是用Origin做的，误差估计啥的经常是拿着计算器手算的，最后到打印店把做好的图用A4纸打出来，裁剪好贴到手写的报告上面去。到了本科高年级的物理课和研究项目中，手写的报告几乎不复存在了，无论是实地操作的仪器中采集的数据，还是计算机模拟跑出来的数据，数据分析和处理全部电子化了。大三开始接触MATLAB进行动态绘图，大四上手LaTeX折腾得死去活来但入门后蓦然回首发现公式、图表和排版竟然可以如此简单，画图这事儿就自然而然地走进了我的日常学习之中。做本科毕业论文的时候，主要的粒子模拟是用Fortran跑的，输出的格式也是自定义的，然后传到MATLAB里面画图做动画分析结果。

##

研究生以后画图更成了家常便饭的活，各种project需要的图主要靠MATLAB做，而组里做研究主要靠IDL。IDL这门古早的语言至今还被用在大量空间物理的数据分析中，虽然我就几乎没见过年轻人说它的好话。当年理论力学课最后李毅教授曾经展示过他写的陀螺模拟程序，还有GUI界面，似乎就是IDL写的。研究生组里老板精通Fortran,Perl和IDL，用IDL写一整套的模拟数据可视化包，渡过安装的镇痛后，参照说明操作绘图倒是非常便利。然而这里的“便利”，指的是照猫画虎做既定规格的图的时候——若是遇到稍微想订制一下的出版规格的图，基于IDL的这套工具用起来真是有苦难言。当时Python已经火起来了，组里也有老师写了个Python的模拟文件处理程序，但一来我并不喜欢Python，二来这个包第一次安装时还失败了，所以就没了下文。

折磨两年后，17年暑假我回国，励精图治开始写一个基于MATLAB的模拟数据分析包。多年的课程锻炼让我对MATLAB绘图如数家珍，所以主要的难点在于数据格式的读入。我们组这个小作坊说来也是神奇，几乎所有的研究工具都是私人定制的，其中也包括数据格式。这格式显然是没有啥文档说明的，尤其是主要使用的二进制文件，只能靠读源代码进行分析。花了一个月，我参考老板的IDL包写出了自己的MATLAB包的雏形。这也是我真正意义上对于数据处理和绘图底层架构的入坑尝试，收获了非常多的实战经验。我第一篇文章中所有的图都是拿这个MATLAB包做的。

18年底，机缘巧合我结识了Julia。关于这段故事，详情可以转见[Perception](https://henry2004y.github.io/JuliaNotes/menu7/). 19年初，我觉得时机已然成熟，为何不写个基于Julia的模拟数据处理包呢？有了先前MATLAB包的经验，这次改写效率高了很多，基本上一个星期就完成了第一版。期间遇到的主要问题源于我对Julia的不熟悉以及Julia本身对于文件I/O底层的支持当时还不够健全（譬如`read!(iostream, @view A[:,1])` 这样的操作，在Julia 1.4以前并不原生支持，需要一些hack）。然而这次改写，加上Julia本身对于绘图后端选择的强调，让我开始思考我们需要一个什么样的数据可视化包。我们可以越俎代庖般给所有的已有绘图库中的方法添加自己写的一套wrapper，并且定制所有的参数，但是这么做的代价就是出产的包异常臃肿并且难以维护：每当遇到新的情景，新的参数，你都需要在wrapper中添加相应的改动，最终的代码就会又臭又长。这里不得不提Python中令我深受启发的特殊传参方法 `*args` 和 `**kwargs`： Julia中类似的操作叫做splat operator `...`，利用它，你可以很方便的为已有的方法构建简洁的wrapper。

不久后我意识到Julia中三维绘图分析功能相比于Tecplot和ParaView来说实在是太简陋了，于是四处寻找解决办法。Tecplot是一款组里一直在使用的三维数据可视化软件，功能很强大，可惜是收费的。它的数据格式除了最新的高性能并行规格作为商业机密保密以外其它的都有详细的说明，所以组里的计算程序能够直接输出该老格式的文件。遗憾的是，这个格式并不能直接被ParaView读取。ParaView是一款业界非常出名的三维可视化开源软件，同他的兄弟VisIt一样师出VTK，也已经深耕了二三十年。VTK则是一套历史悠久的计算机图形学底层库，定义了诸多基础几何结构的表示方法，也是现在诸多可视化的软件的基石。这时候我也临近毕业，一心的想法就是不能栓死在付费小众软件上，而应向着更通用的格式靠拢，于是详细了解了VTK的基本格式，包括传统的和现代基于XML的，并且上手了ParaView的操作流程。更巧的是，一位Julia社区中的法国人搞出了一个生成基于XML格式的VTK文件的开源包，打通了最后一个关节。虽然从Tecplot的PLT到VTK格式转换需要些时间，但是受惠于XML中的压缩算法文件大小可以减小2-10倍，在我看来是非常重要的优势。这里的逻辑有点绕，但结局是我搭好了Julia+ParaView的可视化分析生态，并成功应用到了第二篇科学文章的数据分析之中。

##

当我开始芬兰的博士后工作后，这边的组里又是一套全新的C++代码+数据格式+自定义Python包。如果是个写的好维护的好的Python包我也就直接用了，可是我进组两个月屡次要求开发者在文档缺失的情况下给一个绘图包的使用教学，一路被各种莫名其妙的借口拖到看不见尽头......我一念之下自己动手从零开始用Julia写了一个新的。所幸这次数据格式的文档还不错，Python理解起来也不难，第一版的数据读取+简易绘图模块大概两周弄出来了。这次的新挑战在于，原先的Python代码头重脚轻的逻辑让我看得连连叹息：在读取数据这块，它定义了Python class中最核心的方法是一个通用参数的接口，之后在各个地方再调用基于这个通用方法的实现。众所周知，Python是一门本来就不是以速度闻名的动态语言，这么一折腾更是代码又长运行又慢。如果我照着原样翻译一遍，当然可以立刻在Julia中运行，但是运行效率上一定是没谱的。于是凭借两年来写Julia的经验、对文件格式的理解、以及对Python代码的分析，我重头构建了整个数据流的逻辑，[结果](https://henry2004y.github.io/Vlasiator.jl/dev/log/#Benchmarks)是小文件读取快了5倍，相对大文件读取也快了2倍以上——根据我先前的经验，这部分主要的时间都消耗在了系统I/O上面，理论上Python的I/O由于是用C实现的，不会比任何语言慢。这不能反映出我的Julia代码写得好，只能说明原先的Python代码的确存在设计问题。

后来陆陆续续我不断在丰富这个Julia包的功能、构建完整的测试和文档，并且注册到了官方包管理目录中以方便安装使用。基于Python Matplotlib的绘图后端代码，我用200行实现了原先Python中1200行实现的功能。还是那句话，不是友军太给力，奈何敌军不争气。最开始的时候，我其实也可以选择全面更新已有的Python代码，但是出于对劝服先前开发者维护者改动的疑虑、所有功能的重新实现工作量的担忧、以及淘汰老旧错误使用习惯的代价，我放弃了走这条路的念头。用新工具很多时候不得不从头造轮子，但是相应的我们没有历史的负担，不必念及旧情。于是临近一年时间这个包的版本号也即将达到0.8,而我的如意算盘则是在手头的新数据分析完发文章的那一天达成1.0的目标。